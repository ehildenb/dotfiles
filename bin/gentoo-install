#!/usr/bin/env zsh

warn() {
    while read -t 0; do :; done
    echo '================================================================================'
    echo -e $@
    echo '================================================================================'
    echo 'Press enter to continue...'
    read
}

command="$1"
shift

case "$command" in
    'stage3')
        dest="$1"    && shift
        tarball="$1" && shift
        warn "MAKE SURE THAT THE ROOT PARTITION IS FORMATTED AND MOUNTED AT '$dest'"
        warn "MAKE SURE THAT '$dest/boot' EXISTS, AND THAT THE BOOT PARTITION IS MOUNTED THERE"
        sudo tar --extract --verbose --bzip2 --preserve-permissions --xattrs \
                 --file="$tarball" --directory="$dest"
        ;;
    'mount')
        dest="$1" && shift
        sudo mount -t proc /proc $dest/proc
        sudo mount --rbind /sys $dest/sys
        sudo mount --make-rslave $dest/sys
        sudo mount --rbind /dev $dest/dev
        sudo mount --make-rslave $dest/dev
        sudo chmod 1777 /dev/shm
        ;;
    'chroot')
        dest="$1" && shift
        sudo cp -r $DOTFILES/etc/portage/{make.conf,repos.conf} $dest/etc/portage
        sudo cp $DOTFILES/etc/portage/package.accept_keywords/intel $dest/tmp
        sudo cp /etc/fstab $dest/tmp
        sudo cp $DOTFILES/etc/conf.d/linux $dest/tmp/config
        sudo cp $DOTFILES/etc/conf.d/firmware/iwlwifi-3160-ucode-16.242414.0/iwlwifi-3160-16.ucode $dest/tmp/
        sudo cp $(which git) $0:A $dest/usr/bin/
        sudo sed --in-place 's*#!/usr/bin/env zsh*#!/usr/bin/env bash*' $dest/usr/bin/gentoo-install
        sudo cp /etc/resolv.conf $dest/etc/resolv.conf
        sudo chroot $dest /bin/bash
        ;;
    'init-emerge')
        source /etc/profile
        export PS1="(chroot) $PS1"
        emerge --sync
        [[ -f "/usr/bin/git" ]] && rm /usr/bin/git
        emerge --update --deep --newuse @world
        eselect news read all
        ;;
    'interactive-config')
        eselect profile list
        warn "SELECT PROFILE"
        read profile
        eselect profile set "$profile"
        warn "FIX THE FSTAB ROOT ENTRY"
        mv /tmp/fstab /etc/fstab
        nano /etc/fstab
        warn "SET PASSWORD FOR 'root'"
        passwd
        ;;
    'auto-config')
        echo "America/Chicago" > /etc/timezone
        emerge --config sys-libs/timezone-data
        sed --in-place 's/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
        locale-gen
        echo 'LANG="en_US.UTF-8"' > /etc/env.d/02locale
        echo 'LC_COLLATE="C"'    >> /etc/env.d/02locale
        echo 'hostname="gentoo-ehildenb"' > /etc/conf.d/hostname
        env-update && source /etc/profile && export PS1="(chroot) $PS1"
        ;;
    'install-kernel')
        emerge sys-kernel/gentoo-sources
        mkdir -p /lib/firmware
        cp /tmp/iwlwifi-3160-16.ucode /lib/firmware/
        cp /tmp/config /usr/src/linux/.config
        pushd /usr/src/linux
        make && make modules_install && make install
        popd
        ;;
    'install-base')
        mkdir -p /etc/portage/package.accept_keywords
        cp /tmp/intel /etc/portage/package.accept_keywords/intel
        emerge --newuse pciutils usbutils acpi parted \
                        iw wpa_supplicant dhcpcd iwl3160-ucode \
                        dcron cups sysklogd logrotate \
                        sudo pm-utils git htop zip dosfstools dos2unix ncurses \
                        zsh tmux kakoune vim w3m
        rc-update add keymaps boot
        rc-update add consolefont boot
        rc-update add dcron boot
        rc-update add cupsd default
        ;;
    'add-user')
        useradd --home-dir /home/ehildenb -M --shell $(which zsh) \
                --user-group --groups wheel,audio,video,users,cron ehildenb
        warn "SET PASSWORD FOR 'ehildenb'"
        passwd ehildenb
        warn 'MODIFY SUDOERS\n%wheel ALL=(ALL) ALL\nehildenb ALL=(ALL) NOPASSWD: /usr/sbin/pm-suspend'
        visudo
        ;;
    'cleanup')
        dest="$1" && shift
        [[ -f "$dest/usr/bin/gentoo-install" ]] && sudo rm "$dest/usr/bin/gentoo-install"
        sudo umount -l "$dest/dev{/shm,/pts,}"
        sudo umount -R "$dest"
        ;;
    'install-grub')
        warn "MAKE SURE THE BOOT PARTITION IS MOUNTED AT '/boot'"
        sw install grub os-prober
        sudo grub-install /dev/sda
        sudo grub-mkconfig -o /boot/grub/grub.cfg
        ;;
    'init-setup')
        source $DOTFILES/zsh/aliases
        sudo cp $DOTFILES/etc/conf.d/{keymaps,consolefont} /etc/conf.d/
        cp_etc portage/
        cp_etc cups/
        lpadmin -p siebl-2203-printer -P /etc/cups/ppd/siebl-2203-printer.ppd \
                -o printer-is-shared=false -o printer-error-policy=abort-job \
                -o job-sheets-default=none -o sides=two-sided-long-edge \
                -o wrap=true -o prettyprint=true \
                -v lpd://engr-print-01.engr.illinois.edu/siebl-2203-printer
        cupsaccept siebl-2203-printer
        cupsenable siebl-2203-printer
        ;;
    'install-packages')
        sw install mutt offlineimap msmtp \
                   cmus ffmpeg alsa-utils youtube-dl \
                   texlive texmfind texlive-latexextra texlive-fontsextra texlive-mathextra texlive-xetex \
                   pandoc pandoc-citeproc mupdf graphicsmagick ghostscript-gpl \
                   rtorrent firefox xinit xorg-server bitcoin-cli bitcoind \
                   weechat bitlbee app-text/tree fbterm \
                   virtual/jdk dev-java/icedtea maven-bin jre scala sbt
        ;;
esac
