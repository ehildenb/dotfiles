#!/usr/bin/env zsh

# system-stats
# ------------

hw_bat() {
    bat=($(acpi -b))
    bat_state="${bat[3]:0:1}"
    bat_percent="${bat[4]%,}"
    bat_time="${bat[5]}"
    case "$bat_state" in
        F) echo "$bat_state"'-'"$bat_percent"           ;;
        *) echo "$bat_state"'-'"$bat_percent $bat_time" ;;
    esac
}

hw_temp() {
    temps_dir='/sys/class/thermal'
    for temp_file in $(ls -d $temps_dir/thermal_zone*); do
        temp="$(cat "$temp_file/temp")"
        echo $(($temp/1000))
    done
}

# suspend/hibernate
# -----------------

hw_mem() {
    lid_file='/proc/acpi/button/lid/LID0/state'
    while grep 'open' "$lid_file" &> /dev/null; do sleep 2; done                        # lid closed
    for i in $(seq 1 30); do [[ "$(lpstat | wc -l)" == '0' ]] && break;
        echo "waiting for print queue ..."
        sleep 2;
    done
    sudo pm-suspend
    grep 'closed' "$lid_file" && hw_mem
    return 0
}

hw_hib() {
    sudo pm-hibernate
}

# screen brightness
# -----------------

hw_brightness() {
    screen_dir='/sys/class/backlight/intel_backlight'
    brightness_file="$screen_dir"'/brightness'
    max_bright="$(cat "$screen_dir"'/max_brightness')"
    curr_bright="$(cat "$brightness_file")"
    if [[ -n "$1" ]]
    then
        sudo zsh -c "echo $(($1 * $max_bright / 100)) > $brightness_file"
    else
        echo "$((100 * $curr_bright / $max_bright))%"
    fi
}

# screen redshift
# ---------------

hw_redshift() {
    temperature='4800'
    [[ -n "$1" ]] && temperature="$1" && shift
    case "$temperature" in
        day)   temperature='4800' ;;
        night) temperature='2200' ;;
    esac

    for display in 0 1 2 3 4 5 6 7 8; do
        echo
        echo "DISPLAY $display"
        echo "export DISPLAY=:$display; redshift -O $temperature; exit" | sudo -u sandbox $(which zsh)
        export DISPLAY=:$display; redshift -O $temperature
    done
}


# Main functionality
hw_command="$1"
shift
case "$hw_command" in
    bat)           hw_bat $@                                  ;;
    temp)          hw_temp $@                                 ;;
    mem)           hw_mem $@                                  ;;
    br|brightness) hw_brightness $@                           ;;
    rs|redshift)   hw_redshift $@                             ;;
    *)             echo "Unrecognized command: '$hw_command'" ;;
esac
