#!/usr/bin/env bash

# fail on any command failure
set -e

# settings
sync=(offlineimap)
index=(notmuch new)
list=(notmuch search)
read=(notmuch tag -inbox)

# reporting
_report() { echo "== mukk: $@" >&2 ; }
_warn()   { _report "[WARNING] $@" ; }
_die()    { _report "[ERROR] $@" ; exit 1 ; }

# Functionality
# -------------

mukk_sync() {
    while [[ "$(ps aux | grep -c "$sync")" -gt '1' ]]; do
        _warn "Potential instance of '$sync' running..."
        sleep 2
    done
    "${sync[@]}" "$@"
    "${index[@]}"
}

mukk_index() {
    "${index[@]}" "$@"
}

mukk_list() {
    "${list[@]}" "$@"
}

mukk_read() {
    "${read[@]}" "$@"
}

# Main
# ====

_usage() {
    exit_status="$1"
    echo "
    usage:
        $0 (s|sync):            download new email
        $0 (i|index):           tag/index existing email
        $0 (l|list) [FILTER+]:  list given emails
        $0 (r|read) [FILTER+]:  remove 'inbox' tag from given emails

    where:
        FILTER:  filters on the emails to apply"
    exit "$exit_status"
}

{ mukk_command="$1" && shift ; } || _usage 1
case "$mukk_command" in
    s|sync)  mukk_sync  "$@" ;;
    i|index) mukk_index "$@" ;;
    l|list)  mukk_list  "$@" ;;
    r|read)  mukk_read  "$@" ;;
    *)       echo "Unrecognized command: '$mukk_command'"
             _usage 1
             ;;
esac
